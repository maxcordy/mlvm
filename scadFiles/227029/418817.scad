//------------------------------------------------------------
//	Stencil-o-Matic
//
//	input comes from:
//	http://chaaawa.com/stencil_factory/
//
//	http://thingiverse.com/Benjamin
//	http://www.thingiverse.com/thing:55821
//------------------------------------------------------------

// preview[view:south, tilt:top]

light_height = 50;
projection_width=200;
enclosure_scale = 110; //[105:150]
thickness=1;
enclosure_type=0; //[0:Sphere,1:Diamond,2:Cylinder]
base_offset=10;
use_bounding_box=0; //[1:Yes,0:No]
bounding_box_width=200; //Input the size box you want the light to be limited by

// If you don't want to center
offX = 0;
offY = -40;

// paste here after "Convert&Copy"
//input = "no_input";
input = [[391,111],[[234.82,91],[234.25,92.09],[234.19,94.71],[234.5,98.42],[243,101.75],[249.96,104.53],[254.75,106.53],[257.05,107.81],[258,108.86],[256.58,110.1],[253.18,111.83],[248.32,113.78],[243.43,115.54],[239.29,117.12],[236.25,118.61],[234.56,120.43],[234,123.02],[234.43,125.4],[236.12,126],[239.28,125.29],[243.87,123.58],[250.86,120.62],[259.75,116.91],[270,112.65],[270,108.84],[270,105.03],[266.25,103.44],[259.67,100.72],[249.13,96.42],[239.41,92.59],[234.82,91]],[[253.71,134.07],[251.61,134.68],[248.25,136.03],[244,137.92],[243.98,142.71],[243.75,146.44],[243.22,148.68],[241.52,149.6],[238.49,150.18],[234.5,150.5],[234.5,154],[234.5,157.5],[238.49,157.82],[241.52,158.4],[243.22,159.32],[243.76,165],[243.99,177],[244.33,191.25],[245.96,196.7],[248.37,199.37],[251.7,201.01],[256.29,201.71],[262,201.82],[268.5,201.5],[268.81,197.75],[268.72,194.89],[267.81,193.89],[266.11,193.87],[263.88,193.96],[261.18,193.38],[258.38,191.65],[255.5,189.18],[255.5,173.84],[255.5,158.5],[262.5,158],[269.5,157.5],[269.5,154],[269.5,150.5],[262.5,150],[255.5,149.5],[255.21,141.75],[254.69,135.91],[253.71,134.07]],[[27.5,149.2],[20.62,149.34],[16.5,150.52],[13.74,152.26],[11.33,154.17],[9.45,156.45],[7.97,159.08],[7.29,161.56],[7.35,163.48],[8.84,164.63],[12.22,164.98],[15.57,164.76],[17.62,164.23],[18.59,163.1],[19.38,161.4],[20.59,159.58],[22.57,158.15],[24.86,157.34],[26.82,157],[28.7,157.46],[30.78,158.56],[33,160.11],[33,179.43],[33.28,195.15],[34.43,199.94],[36.7,200.68],[40.18,200.81],[44.5,200.5],[44.77,181.69],[44.67,167.17],[44.01,159.05],[42.3,155.47],[39.24,152.36],[34.77,149.94],[27.5,149.2]],[[73.36,149],[67.07,149.49],[62.14,151.16],[58.21,153.86],[54.89,157.31],[52.52,161.34],[50.89,165.4],[50.24,170.27],[50.25,176.21],[51.28,182.63],[53.44,188.47],[56.31,193.11],[59.4,196.49],[62.95,198.68],[66.94,200.48],[72.02,201.55],[78.16,202],[84.05,201.57],[88.53,200.55],[91.36,198.79],[92,195.96],[92,192.81],[87.05,193.49],[82.01,193.62],[76.76,192.62],[72.35,190.85],[69.27,188.78],[67.15,185.85],[65.08,182],[63.57,177.15],[63.02,171.65],[63.46,166.54],[64.57,162.49],[66.55,159.77],[69.16,157.93],[72.09,157.21],[74.81,157.6],[77.03,158.99],[78.66,161.01],[79.69,163.3],[80.43,165.3],[81.94,166.71],[86.74,166.8],[92.5,166.5],[92.22,163.07],[91.46,159.74],[90.02,156.53],[87.51,153.69],[84.16,151.21],[79.6,149.47],[73.36,149]],[[120.18,149.22],[113.28,149.4],[108.5,150.84],[104.91,153.03],[101.9,155.62],[99.58,158.91],[97.65,162.77],[96.48,167.69],[96,173.55],[96.54,179.82],[97.99,185.71],[100.2,190.57],[102.74,194.31],[106.16,197.08],[110.5,199.62],[115.93,201.47],[122.5,201.98],[128.54,201.68],[133.24,200.95],[136.25,199.59],[137.59,197.51],[137.82,195.51],[137.53,194.05],[135.99,193.46],[133.01,193.61],[128.77,193.69],[124.01,193],[119.51,191.4],[115.91,189.27],[113.37,186.65],[111.44,183.88],[110.1,180.36],[108.99,175.93],[108.53,170.96],[109.07,166.19],[110.27,162.39],[111.69,159.79],[113.78,158.37],[116.58,157.42],[119.64,157.35],[122.19,158.42],[124.14,160.51],[125.59,163.27],[126.68,166.5],[132.09,166.5],[137.5,166.5],[137.38,162.66],[136.72,159.18],[135.32,156.22],[133.14,153.78],[130.62,151.57],[126.82,149.89],[120.18,149.22]],[[168.97,149],[167.62,149.2],[166.67,149.67],[166.2,150.9],[166,152.94],[166.8,155.58],[169.08,158.26],[171.17,160.68],[171.82,162.68],[170.85,164.08],[168.99,165],[167.01,166.07],[166.5,168.55],[166.5,171.5],[174.5,171.5],[182.5,171.5],[182.82,167.58],[182.55,163.51],[181.45,159.23],[179.12,155.14],[175.18,151.9],[171.47,149.85],[168.97,149]],[[217.17,149.06],[213.29,149.35],[210.5,149.95],[208.38,151.3],[206.08,153.39],[204.16,155.23],[202.95,156],[202.28,155.1],[201.64,152.95],[201.03,149.89],[195.76,150.2],[190.5,150.5],[190.5,175.5],[190.5,200.5],[195.4,200.81],[199.28,200.71],[201.14,199.81],[201.73,195.21],[201.99,186],[202.29,176.14],[202.98,170],[204.54,166.57],[206.92,163.25],[209.88,160.78],[212.82,160],[215.3,160.48],[217.13,161.65],[218.3,167.1],[219,181.9],[219.5,200.5],[224.5,200.5],[229.5,200.5],[229.77,180.01],[229.69,163.91],[228.89,156.74],[227.21,154.05],[224.79,151.48],[221.48,149.54],[217.17,149.06]],[[350,149.29],[347.65,149.39],[345.5,149.94],[343.22,151.45],[340.56,153.9],[338.27,156.09],[336.88,157],[336.25,156.05],[335.81,153.75],[335.5,150.5],[330,150.5],[324.5,150.5],[324.5,175.5],[324.5,200.5],[330,200.5],[335.5,200.5],[336,185.5],[336.7,173.95],[337.74,168.33],[339.4,166.18],[341.64,164.07],[344.66,162.41],[348.16,161.36],[351.3,160.39],[352.59,158.51],[352.89,155.94],[352.82,152.89],[352.08,150.11],[350,149.29]],[[380.7,149],[379.54,149.2],[378.67,149.67],[378.2,150.84],[378,152.73],[378.98,155.4],[381.6,158.53],[384.01,161.3],[384.76,163.21],[383.6,164.27],[381.42,165.01],[379.04,165.98],[378.5,168.51],[378.5,171.5],[386.99,171.5],[394.1,171.18],[395.83,169.63],[395.89,167.01],[395.53,163.34],[394.23,159.12],[391.7,155.31],[388.51,152.36],[385.3,150.35],[382.61,149.4],[380.7,149]],[[155.5,150.39],[153.89,150.83],[151.42,152.24],[148.63,154.66],[146.26,157.53],[144.47,160.92],[143.09,164.6],[142.33,168.72],[142.01,173.16],[142.56,178.25],[143.9,183.94],[146.05,189.31],[148.54,193.64],[151.96,196.87],[156.38,199.6],[162,201.48],[169,201.98],[175.03,201.6],[179,200.71],[180.99,198.96],[181.82,196.09],[182.15,192.72],[177.06,193.4],[172.31,193.56],[168.04,193.01],[164.31,191.47],[160.9,189.26],[157.96,185.89],[155.37,181.54],[153.71,177.48],[153.01,174.79],[153.59,173.26],[155,172],[156.41,170.62],[157,168.79],[156.54,166.77],[155.43,164.92],[153.85,163.18],[155.49,160.03],[156.55,156.89],[156.81,153.76],[156.3,151.49],[155.5,150.39]],[[282.05,150],[278.52,150.2],[276.67,150.67],[276.2,156.81],[276,170.65],[276.32,186.87],[277.6,193.96],[279.66,197.41],[282.47,199.98],[285.86,201.41],[289.42,202],[292.81,201.59],[295.8,200.6],[298.42,198.84],[300.92,196.6],[302.86,194.76],[304.11,194],[304.74,194.95],[305.19,197.25],[305.5,200.5],[311,200.5],[316.5,200.5],[316.5,175.5],[316.5,150.5],[311,150.5],[305.5,150.5],[304.93,164.5],[304.09,176.3],[302.57,182.77],[300.56,186.37],[298.25,189.02],[295.64,190.42],[292.9,191],[290.55,190.49],[289.04,189.07],[288.29,183.02],[287.99,170.82],[287.8,158.63],[287.37,152.25],[286.03,150.4],[282.05,150]],[[368.5,150.35],[366.83,150.74],[364.23,152.13],[361.13,154.95],[358.28,158.79],[355.61,163.35],[355.67,172.92],[356.12,181.14],[357.39,186.45],[359.34,190.24],[361.66,193.8],[365,196.91],[369.38,199.6],[375,201.48],[382,201.98],[388.03,201.6],[392,200.71],[393.99,198.96],[394.82,196.09],[395.15,192.72],[390.06,193.4],[385.22,193.56],[380.74,192.95],[376.77,191.23],[373.16,188.67],[370.43,185.7],[368.55,183],[367.45,180.15],[366.6,176.8],[366.43,173.59],[367.96,172.02],[369.4,170.62],[370,168.79],[369.51,166.75],[368.34,164.83],[366.69,163],[368.43,159.75],[369.57,156.6],[369.84,153.58],[369.31,151.42],[368.5,150.35]],[[23.5,172.42],[22.06,172.47],[20,172.94],[17.03,174.09],[13.4,175.79],[9.99,178.06],[7.54,180.58],[6.14,183.58],[5.27,187],[5.34,190.66],[6.42,194.2],[8.72,197.32],[12.03,199.89],[16.05,201.52],[20.24,201.81],[24.5,201.5],[24.81,198.29],[24.47,195.36],[21.54,193.58],[18.77,191.85],[17.11,189.79],[16.72,187.59],[16.97,185.5],[18.56,183.37],[21.39,181.05],[24.34,178.5],[24.8,175.63],[24.29,173.46],[23.5,172.42]]];


module void() {}

vessel_scale=enclosure_scale/100;

points_array = (input=="no_input"? [[179,268],[[199.26,15.12],[189.19,15.56],[181.5,16.45],[175.52,17.83],[169.55,19.42],[163.57,21.55],[157.55,24.22],[151.62,27.5],[145.87,31.09],[140.35,35.49],[135,40.71],[130.05,46.71],[125.52,53],[121.87,59.06],[119.06,64.5],[117.12,69.21],[115.55,73.5],[114.31,77.65],[113.16,82],[112.07,87.29],[110.96,93.7],[110.36,99.39],[110.49,102.95],[111.13,105],[136.96,105],[158.46,104.73],[163.39,103.42],[163.83,101.08],[164.04,97.67],[164.46,93.04],[165.44,87.75],[167.04,82.4],[168.96,77.59],[171.9,73.02],[175.98,68.21],[180.98,63.93],[186.13,60.62],[192.15,58.45],[201.05,58],[208.86,58.34],[214.1,59.16],[217.74,60.82],[221.73,63.19],[225.41,66.46],[228.34,70.28],[230.39,74.63],[231.97,79.15],[232.75,85.01],[232.85,92.65],[232.01,100.96],[229.51,107.41],[225.45,113.48],[218.91,119.91],[211.35,126.37],[203.83,132.63],[197.2,138.54],[191.77,144.13],[187.33,150.15],[183.1,157.07],[179.62,164.83],[176.98,172.85],[175.42,181.69],[175.22,192.28],[175.5,203.5],[199,203.5],[222.5,203.5],[222.74,198.5],[223.25,193.21],[224.15,187.5],[225.64,181.94],[227.6,177],[230.92,172.02],[235.69,166.37],[243.47,159.38],[254,151.21],[264.03,143.56],[270.61,137.84],[274.46,133.36],[277.95,128.69],[281.05,123.47],[283.96,117.69],[286.32,111.7],[288.09,106],[289.06,98.48],[289.47,88],[289.05,76.45],[287.17,68],[284.48,60.83],[281.31,54.14],[276.58,47.41],[270.1,40.14],[262.4,33.38],[254.68,28.12],[246.8,24.2],[238.72,20.92],[230.05,18.48],[220.76,16.55],[210.43,15.49],[199.26,15.12]],[[198.05,226.08],[178.93,226.28],[170.25,226.66],[169.27,232.87],[169,254.48],[169.27,277.23],[170.58,282.39],[179.4,282.82],[198.38,283],[218.91,282.73],[225.8,281.8],[226.73,274.94],[227,254.5],[226.73,234.06],[225.8,227.2],[218.87,226.29],[198.05,226.08]]]: input);

rL=(light_height+base_offset)/2;


intersection(){
	difference(){
		vessel(
			enclosure_type=enclosure_type,
			light_height = light_height,
			thickness=thickness,
			base_offset=base_offset,
			vessel_scale=vessel_scale);
		image_projection(points_array=points_array,
			projection_width=projection_width,
			light_height=light_height,
			offX=offX,
			offY=offY);
	}

	bounding_box(bbwidth=bounding_box_width,light_height=light_height);


}

%image_projection(points_array=points_array,
		projection_width=projection_width,
		light_height=light_height,
		offX=offX,
		offY=offY);

module image_projection(
	points_array,
	projection_width=150,
	light_height=50,
	offX=0,
	offY=0){
	
	dispo_width = projection_width;
	input_width = points_array[0][0];
	input_height= points_array[0][1];
	sTrace = dispo_width/input_width;
	stencil_height = input_height*sTrace;	

	light = [200-offX/sTrace,150+offY/sTrace,light_height];

	
	//translate([offX, offY, 0])
		scale([sTrace, -sTrace, 1])
		//translate([-200, -150, 0])
		for( i = [1:len(points_array)-1])union(){
			linear_extrude(height=light_height,scale=.01)
				translate([-200+offX/sTrace, -150-offY/sTrace, 0])
				polygon(points_array[i]);
//			translate([0,0,-.1])linear_extrude(height=.1)polygon(points_array[i]);
//			for( j = [0:len(points_array[i])-1]){
//						polyhedron(
//							points=[points_array[i][j],points_array[i][j+1],light],
//							triangles=[[0,1,2]]);
//						echo(points_array[i][j],points_array[i][j+1],light);
//			}
		}

}

//[0:Sphere,1:Diamond,2:Cylinder]
module vessel(
	enclosure_type=0,
	light_height = 50,
	thickness=1,
	base_offset=10,
	vessel_scale=1.1){

	d0=(light_height+base_offset)/pow(3,.5);
//	d1=d0*pow(2,.5)*sin(60)-d0*.5*pow(2,.5)*tan(30);
//	d2=pow(d0*d0-d1*d1,.5);

	if(enclosure_type==0)difference(){  //Sphere
		translate([0,0,rL*vessel_scale-base_offset])sphere(r=rL*vessel_scale);
		translate([0,0,-rL])cube(rL*2,center=true);
		difference(){
			translate([0,0,rL*vessel_scale-base_offset])sphere(r=rL*vessel_scale-thickness);	
			translate([0,0,-rL+thickness])cube(rL*2,center=true);
		}
		//translate([0,0,light_height/2])cylinder(r=rL/3,h=light_height,$fn=30);
	}

	if(enclosure_type==1)rotate([0,0,30])difference(){  //Diamond
		translate([0,0,-base_offset])
			rotate([0,-asin(1/pow(3,.5)),0])
			rotate([45,0,0])
			cube(d0*vessel_scale);
		difference(){
			translate([0,0,-base_offset+thickness*pow(3,.5)])
				rotate([0,-asin(1/pow(3,.5)),0])
				rotate([45,0,0])
				cube(d0*vessel_scale-2*thickness);
			translate([0,0,-rL+thickness])cube(rL*2,center=true);
		}
	}

	if(enclosure_type==2)difference(){  //Cylinder
		cylinder(r=light_height*vessel_scale/(1.618*2),h=light_height*vessel_scale,$fn=30);
		translate([0,0,thickness])cylinder(r=light_height*vessel_scale/(1.618*2)-thickness,h=light_height*vessel_scale-2*thickness,$fn=30);
		//translate([0,0,light_height/2])cylinder(r=rL/3,h=light_height,$fn=30);

	}

}

module bounding_box(bbwidth,light_height){
	if(use_bounding_box==1)linear_extrude(height=light_height,scale=.001)square(bbwidth,center=true);
	if(use_bounding_box!=1||enclosure_type==1)linear_extrude(height=light_height)circle(r=bbwidth,center=true,$fn=30);
}





